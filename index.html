<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Messenger - Page 2</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<style>
*{box-sizing:border-box;font-family:'Roboto',sans-serif;margin:0;padding:0;}
body{background:#f0f2f5;display:flex;justify-content:center;align-items:center;height:100vh;}
.chat-container{width:500px;max-width:95%;height:600px;background:white;border-radius:15px;display:flex;flex-direction:column;box-shadow:0 8px 20px rgba(0,0,0,0.15);}
.chat-header{background:#1877f2;color:white;font-size:20px;padding:20px;text-align:center;border-top-left-radius:15px;border-top-right-radius:15px;font-weight:500;position:relative;}
.typing-indicator{font-size:12px;color:#dcdcdc;position:absolute;bottom:5px;left:20px;display:none;}
.chat-messages{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:#f0f2f5;}
.message-row{display:flex;align-items:flex-end;gap:10px;}
.sent{justify-content:flex-end;} 
.received{justify-content:flex-start;}
.message{max-width:70%;padding:12px 18px;border-radius:20px;font-size:16px;word-wrap:break-word;position:relative;transition:transform 0.2s;background:#25d366;color:white;border-bottom-right-radius:0;}
.received .message{background:#e4e6eb;color:black;border-bottom-left-radius:0;}
.message img{max-width:100%;border-radius:10px;margin-top:5px;}
.message a{color:#0645AD;text-decoration:underline;word-break:break-word;}
.avatar{width:35px;height:35px;border-radius:50%;}
.timestamp{font-size:10px;color:gray;margin-top:3px;text-align:right;}
.reactions{display:flex;gap:5px;margin-top:3px;}
.reaction{cursor:pointer;font-size:14px;transition:transform 0.2s;}
.reaction:hover{transform:scale(1.3);}
.chat-input{display:flex;flex-direction:column;padding:10px;border-top:1px solid #ccc;background:#fff;border-bottom-left-radius:15px;border-bottom-right-radius:15px;}
#dropArea{padding:10px;border:2px dashed #ccc;border-radius:10px;text-align:center;margin-bottom:5px;color:#888;font-size:14px;transition:0.3s;}
#dropArea.hover{border-color:#25d366;color:#25d366;}
#filePreview{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px;}
#filePreview div{background:#f1f1f1;padding:5px 8px;border-radius:5px;font-size:12px;}
.chat-input textarea{flex:1;padding:10px 15px;border-radius:20px;border:1px solid #ccc;font-size:16px;resize:none;height:40px;transition:all 0.3s;margin-bottom:5px;}
.chat-input textarea:focus{border-color:#25d366;box-shadow:0 0 5px rgba(37,211,102,0.5);outline:none;}
.chat-input button{background:#1877f2;color:white;border:none;border-radius:25px;padding:10px 15px;cursor:pointer;font-size:16px;transition:background 0.3s;margin-top:5px;}
.chat-input button:hover{background:#145dbf;}
</style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        Messenger - User 2
        <div id="typingIndicator" class="typing-indicator">User 1 is typing...</div>
    </div>
    <div id="messages" class="chat-messages"></div>
    <div class="chat-input">
        <div id="dropArea">Drag & Drop files here or click below</div>
        <div id="filePreview"></div>
        <textarea id="inputMessage" placeholder="Type a message..."></textarea>
        <input type="file" id="fileInput" multiple style="margin-bottom:5px;">
        <div style="display:flex;gap:5px;">
            <button onclick="sendMessage()">Send</button>
            <button onclick="addEmoji()">ðŸ˜Š</button>
        </div>
    </div>
</div>
<audio id="msgSound" src="https://www.soundjay.com/button/sounds/button-16.mp3"></audio>

<script>
// Pusher Initialization with your keys
const pusher = new Pusher('b4be98312628a4e18191', {
  cluster: 'sa1',
  forceTLS: true
});

// Using a private- channel allows for Client Events (browser-to-browser)
// Note: Requires "Enable Client Events" in Pusher Dashboard
const channel = pusher.subscribe('private-chat-channel');

let filesToSend = [];

function addEmoji(){document.getElementById("inputMessage").value+="ðŸ˜Š";}
function getMessages(){return JSON.parse(localStorage.getItem("chatMessages")||"[]");}
function saveMessages(msgs){localStorage.setItem("chatMessages",JSON.stringify(msgs));}

// Listen for incoming messages
channel.bind('client-new-message', function(data) {
    if(data.sender !== "page2") {
        const messages = getMessages();
        messages.push(data);
        saveMessages(messages);
        displayMessages();
        document.getElementById("msgSound").play();
    }
});

// Listen for typing status
channel.bind('client-typing', function(data) {
    if(data.sender === "page1") {
        document.getElementById("typingIndicator").style.display = data.isTyping ? "block" : "none";
    }
});

function displayMessages(){
    const container=document.getElementById("messages");
    const messages=getMessages();
    container.innerHTML = "";
    messages.forEach(msg => {
        const row=document.createElement("div");
        row.classList.add("message-row", msg.sender === "page2" ? "sent" : "received");
        
        const avatar=document.createElement("img");
        avatar.classList.add("avatar");
        avatar.src = msg.sender === "page2" ? "https://i.pravatar.cc/35?img=3" : "https://i.pravatar.cc/35?img=4";
        
        const bubble=document.createElement("div");
        bubble.classList.add("message");
        bubble.innerHTML = (msg.text ? msg.text : "") + `<div class="timestamp">${msg.time} ${msg.seen ? "âœ” Seen" : ""}</div>`;
        
        if(msg.files){
            msg.files.forEach(f => {
                if(f.type.startsWith("image/")){
                    const imgEl=document.createElement("img");
                    imgEl.src=f.data;
                    bubble.appendChild(imgEl);
                } else {
                    const link=document.createElement("a");
                    link.href=f.data; link.target="_blank"; link.innerText=f.name;
                    bubble.appendChild(link);
                }
            });
        }
        
        if(msg.sender === "page2"){
            row.appendChild(bubble); row.appendChild(avatar);
        } else {
            row.appendChild(avatar); row.appendChild(bubble);
        }
        container.appendChild(row);
    });
    container.scrollTop=container.scrollHeight;
}

const input=document.getElementById("inputMessage");
input.addEventListener("input", () => {
    channel.trigger('client-typing', { sender: "page2", isTyping: input.value.length > 0 });
});

const dropArea=document.getElementById("dropArea");
const fileInput=document.getElementById("fileInput");
const filePreview=document.getElementById("filePreview");

dropArea.addEventListener("dragover",e=>{e.preventDefault();dropArea.classList.add("hover");});
dropArea.addEventListener("dragleave",e=>{e.preventDefault();dropArea.classList.remove("hover");});
dropArea.addEventListener("drop",e=>{e.preventDefault();dropArea.classList.remove("hover");handleFiles(e.dataTransfer.files);});
fileInput.addEventListener("change",e=>{handleFiles(e.target.files);});

function handleFiles(files){for(let f of files){filesToSend.push({name:f.name,type:f.type,file:f});const div=document.createElement("div");div.innerText=f.name;filePreview.appendChild(div);}}

function sendMessage(){
    const text=input.value.trim();
    if(!text && filesToSend.length===0) return;
    const now=new Date(); 
    const time=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');
    
    if(filesToSend.length > 0){
        let filesData=[]; let processed=0;
        filesToSend.forEach(f=>{
            const reader=new FileReader();
            reader.onload=e=>{
                filesData.push({name:f.name,type:f.type,data:e.target.result});
                processed++;
                if(processed===filesToSend.length){broadcast(time, text, filesData);}
            }
            reader.readAsDataURL(f.file);
        });
    } else { broadcast(time, text, []); }
}

function broadcast(time, text, filesData) {
    const msgData = { sender: "page2", text, time, seen: false, files: filesData };
    
    // Trigger real-time event to User 1
    channel.trigger('client-new-message', msgData);
    
    // Save locally for history
    const messages = getMessages();
    messages.push(msgData);
    saveMessages(messages);
    
    // UI Updates
    displayMessages();
    input.value=""; 
    filesToSend=[]; 
    filePreview.innerHTML="";
    channel.trigger('client-typing', { sender: "page2", isTyping: false });
    document.getElementById("msgSound").play();
}

input.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});
displayMessages();
</script>
</body>
</html>
