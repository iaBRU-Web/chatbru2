<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - User 2</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        :root { --p: #42b72a; --bg: #f0f2f5; }
        /* STYLES ARE IDENTICAL TO CHAT 1 */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; justify-content: center; align-items: center; }
        .app { width: 100%; max-width: 500px; height: 90vh; background: white; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .status { width: 10px; height: 10px; background: #31a24c; border-radius: 50%; }
        .box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; }
        .me { align-self: flex-end; background: var(--p); color: white; border-bottom-right-radius: 4px; }
        .them { align-self: flex-start; background: #e4e6eb; color: black; border-bottom-left-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .time { font-size: 10px; opacity: 0.6; display: block; text-align: right; margin-top: 4px; }
        .footer { padding: 15px; border-top: 1px solid #eee; background: white; }
        .in-row { display: flex; gap: 10px; align-items: center; }
        #mIn { flex: 1; border: none; background: #f0f2f5; padding: 12px 18px; border-radius: 25px; outline: none; }
        .btn { color: var(--p); font-size: 24px; cursor: pointer; border: none; background: none; }
        #type { padding: 5px 20px; font-size: 12px; color: #888; display: none; }
    </style>
</head>
<body>
<div class="app">
    <div class="header"><div class="status"></div> User 1 (Live)</div>
    <div class="box" id="chat"></div>
    <div id="type">User 1 is typing...</div>
    <div class="footer">
        <div id="prev" style="font-size: 11px; margin-bottom: 5px;"></div>
        <div class="in-row">
            <input type="file" id="fIn" style="display:none" multiple onchange="hFiles(event)">
            <button class="btn" onclick="document.getElementById('fIn').click()">âŠ•</button>
            <input type="text" id="mIn" placeholder="Aa" autocomplete="off">
            <button class="btn" onclick="send()">âž¤</button>
        </div>
    </div>
</div>
<script>
    // YOUR PRODUCTION KEYS
    const pusher = new Pusher('389324f692322b876741', { cluster: 'ap2', forceTLS: true });
    const channel = pusher.subscribe('private-chat-prod');
    const chat = document.getElementById('chat');
    const mIn = document.getElementById('mIn');
    let q = [];

    const getH = () => JSON.parse(localStorage.getItem('cb_prod_logs') || '[]');
    const setH = (d) => localStorage.setItem('cb_prod_logs', JSON.stringify(d));

    function render() {
        chat.innerHTML = '';
        getH().forEach(m => {
            const d = document.createElement('div');
            d.className = `msg ${m.u === 'u2' ? 'me' : 'them'}`;
            let fs = '';
            if(m.f) m.f.forEach(f => { fs += f.type.includes('image') ? `<img src="${f.d}">` : `<div style="font-size:12px">ðŸ“Ž ${f.n}</div>`; });
            d.innerHTML = `<div>${m.msg}</div>${fs}<span class="time">${m.t}</span>`;
            chat.appendChild(d);
        });
        chat.scrollTop = chat.scrollHeight;
    }

    channel.bind('client-msg', (data) => {
        if(data.u === 'u1') { const h = getH(); h.push(data); setH(h); render(); }
    });

    channel.bind('client-typing', (data) => {
        if(data.u === 'u1') document.getElementById('type').style.display = data.is ? 'block' : 'none';
    });

    function hFiles(e) {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = (ev) => {
                q.push({ n: f.name, type: f.type, d: ev.target.result });
                document.getElementById('prev').innerText += `[${f.name}] `;
            };
            r.readAsDataURL(f);
        });
    }

    function send() {
        const val = mIn.value.trim();
        if(!val && q.length === 0) return;
        const msg = { u: 'u2', msg: val, f: q, t: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) };
        channel.trigger('client-msg', msg);
        const h = getH(); h.push(msg); setH(h);
        mIn.value = ''; q = []; document.getElementById('prev').innerText = '';
        render();
        channel.trigger('client-typing', { u: 'u2', is: false });
    }

    mIn.addEventListener('input', () => { channel.trigger('client-typing', { u: 'u2', is: mIn.value.length > 0 }); });
    mIn.addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
    render();
</script>
</body>
</html>
