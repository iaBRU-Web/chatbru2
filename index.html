<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - User 2</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        :root {
            --primary-color: #42b72a; /* WhatsApp Green style for variety */
            --bg-color: #f0f2f5;
            --text-sent: #ffffff;
            --bg-sent: #42b72a;
            --bg-received: #e4e6eb;
            --text-received: #050505;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg-color); height: 100vh; display: flex; justify-content: center; align-items: center; }

        .chat-wrapper { width: 100%; max-width: 600px; height: 90vh; background: #fff; border-radius: 20px; box-shadow: 0 12px 28px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; }

        .chat-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .online-wrapper { position: relative; width: 40px; height: 40px; }
        
        .messages-area { flex: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 8px; }
        .msg-row { display: flex; width: 100%; margin-bottom: 4px; }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.received { justify-content: flex-start; }

        .bubble { max-width: 70%; padding: 10px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .sent .bubble { background: var(--bg-sent); color: var(--text-sent); border-bottom-right-radius: 4px; }
        .received .bubble { background: var(--bg-received); color: var(--text-received); border-bottom-left-radius: 4px; }

        .bubble img { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        .timestamp { font-size: 11px; opacity: 0.7; margin-top: 4px; display: block; text-align: right; }

        .typing { font-size: 12px; color: #65676b; padding: 5px 20px; display: none; }

        .input-footer { padding: 15px; border-top: 1px solid rgba(0,0,0,0.1); background: #fff; }
        .preview-bar { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .preview-item { background: #f0f2f5; padding: 5px 10px; border-radius: 10px; font-size: 12px; display: flex; align-items: center; gap: 5px; }

        .controls { display: flex; align-items: center; gap: 10px; }
        #messageInput { flex: 1; border: none; background: #f0f2f5; padding: 12px 18px; border-radius: 25px; outline: none; font-size: 15px; }
        .btn-icon { cursor: pointer; color: var(--primary-color); font-size: 20px; transition: 0.2s; }
        #fileBtn { display: none; }
    </style>
</head>
<body>

<div class="chat-wrapper">
    <div class="chat-header">
        <div class="user-info">
            <div class="online-wrapper">
                <img src="https://i.pravatar.cc/150?u=user1" alt="U1">
                <div style="background:#31a24c;" class="status-dot"></div>
            </div>
            <div>
                <strong style="display: block;">User 1</strong>
                <span style="font-size: 12px; color: #31a24c;">Online</span>
            </div>
        </div>
        <div class="btn-icon">â“˜</div>
    </div>

    <div class="messages-area" id="chatBox"></div>
    <div class="typing" id="typingLabel">User 1 is typing...</div>

    <div class="input-footer">
        <div class="preview-bar" id="previewBar"></div>
        <div class="controls">
            <label for="fileBtn" class="btn-icon">âŠ•</label>
            <input type="file" id="fileBtn" multiple onchange="handleFileSelect(event)">
            <input type="text" id="messageInput" placeholder="Message User 1..." autocomplete="off">
            <div class="btn-icon" onclick="sendMsg()">âž¤</div>
        </div>
    </div>
</div>

<audio id="pop" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script>
    const PUSHER_KEY = 'b4be98312628a4e18191';
    const CLUSTER = 'sa1';
    
    const pusher = new Pusher(PUSHER_KEY, { cluster: CLUSTER, forceTLS: true });
    const channel = pusher.subscribe('private-chat');

    let pendingFiles = [];
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.getElementById('messageInput');
    const typingLabel = document.getElementById('typingLabel');

    function getHistory() { return JSON.parse(localStorage.getItem('chat_history') || '[]'); }
    function saveHistory(history) { localStorage.setItem('chat_history', JSON.stringify(history)); }

    function render() {
        chatBox.innerHTML = '';
        getHistory().forEach(m => {
            const div = document.createElement('div');
            div.className = `msg-row ${m.sender === 'u2' ? 'sent' : 'received'}`;
            
            let filesHTML = '';
            if(m.files) {
                m.files.forEach(f => {
                    if(f.type.includes('image')) filesHTML += `<img src="${f.data}">`;
                    else filesHTML += `<div style="text-decoration:underline; font-size:12px;">ðŸ“Ž ${f.name}</div>`;
                });
            }

            div.innerHTML = `<div class="bubble">${m.text ? `<div>${m.text}</div>` : ''}${filesHTML}<span class="timestamp">${m.time}</span></div>`;
            chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    channel.bind('client-msg', (data) => {
        if(data.sender === 'u1') {
            const history = getHistory();
            history.push(data);
            saveHistory(history);
            render();
            document.getElementById('pop').play();
        }
    });

    channel.bind('client-typing', (data) => {
        if(data.sender === 'u1') typingLabel.style.display = data.isTyping ? 'block' : 'none';
    });

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                pendingFiles.push({ name: file.name, type: file.type, data: ev.target.result });
                const p = document.createElement('div');
                p.className = 'preview-item';
                p.innerText = file.name;
                document.getElementById('previewBar').appendChild(p);
            };
            reader.readAsDataURL(file);
        });
    }

    function sendMsg() {
        const text = messageInput.value.trim();
        if(!text && pendingFiles.length === 0) return;

        const msgData = {
            sender: 'u2',
            text: text,
            files: pendingFiles,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        };

        channel.trigger('client-msg', msgData);
        const history = getHistory();
        history.push(msgData);
        saveHistory(history);
        messageInput.value = '';
        pendingFiles = [];
        document.getElementById('previewBar').innerHTML = '';
        render();
        channel.trigger('client-typing', { sender: 'u2', isTyping: false });
    }

    let typingTimer;
    messageInput.addEventListener('input', () => {
        channel.trigger('client-typing', { sender: 'u2', isTyping: true });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            channel.trigger('client-typing', { sender: 'u2', isTyping: false });
        }, 2000);
    });

    messageInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
    render();
</script>
</body>
</html>
